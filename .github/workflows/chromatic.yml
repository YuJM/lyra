name: Chromatic Deployment

on:
  push:
    branches:
      - main
      - dev
      - feat/**
  pull_request:
    branches:
      - main

# Chromatic ë°°í¬ ì‘ì—…ì´ ë™ì‹œì— ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ë°©ì§€
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  chromatic:
    name: Publish to Chromatic
    runs-on: ubuntu-latest

    steps:
      # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ (full git history í•„ìš” - TurboSnapì„ ìœ„í•´)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ git history ê°€ì ¸ì˜¤ê¸° (TurboSnapì— í•„ìˆ˜)

      # 2. pnpm ì„¤ì¹˜
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      # 3. Node.js ì„¤ì •
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'pnpm'

      # 4. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # 5. Turborepo ìºì‹œ ì„¤ì • (ì„ íƒì‚¬í•­ì´ì§€ë§Œ ë¹Œë“œ ì†ë„ í–¥ìƒ)
      - name: Setup Turborepo cache
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-

      # 6. UI íŒ¨í‚¤ì§€ ë¹Œë“œ (Storybook ë¹Œë“œ í¬í•¨)
      - name: Build UI package
        run: pnpm build --filter=@lyra/ui

      # 7. Chromatic ë°°í¬
      - name: Publish to Chromatic
        uses: chromaui/action@latest
        with:
          # Chromatic í”„ë¡œì íŠ¸ í† í° (Repository Secretsì— ì„¤ì • í•„ìš”)
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}

          # Storybook ë¹Œë“œ ê²°ê³¼ë¬¼ ê²½ë¡œ
          storybookBuildDir: packages/ui/storybook-static

          # TurboSnap í™œì„±í™” - ë³€ê²½ëœ ì»´í¬ë„ŒíŠ¸ë§Œ ìŠ¤ëƒ…ìƒ· ì´¬ì˜í•˜ì—¬ ì†ë„ í–¥ìƒ
          onlyChanged: true

          # ì™¸ë¶€ ì˜ì¡´ì„± (TurboSnapì´ ì¶”ì í•  ì¶”ê°€ ê²½ë¡œ)
          # ë””ìì¸ í† í°ì´ë‚˜ ê¸€ë¡œë²Œ ìŠ¤íƒ€ì¼ ë³€ê²½ ì‹œì—ë„ ìŠ¤ëƒ…ìƒ· ì´¬ì˜
          externals: |
            packages/design-tokens/**
            packages/ui/src/global.css

          # main ë¸Œëœì¹˜ì˜ ë³€ê²½ì‚¬í•­ì€ ìë™ ìŠ¹ì¸ (baseline ìœ ì§€)
          autoAcceptChanges: ${{ github.ref == 'refs/heads/main' && 'true' || 'false' }}

          # ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ ë¸Œëœì¹˜ëŠ” ìë™ìœ¼ë¡œ ê±´ë„ˆë›°ê¸°
          skip: 'dependabot/**,renovate/**'

          # ì‹œê°ì  ë³€ê²½ì´ ê°ì§€ë˜ì–´ë„ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤íŒ¨ì‹œí‚¤ì§€ ì•ŠìŒ
          exitZeroOnChanges: true

          # í° í”„ë¡œì íŠ¸ì˜ ê²½ìš° ì••ì¶• í™œì„±í™” (ì—…ë¡œë“œ ì†ë„ í–¥ìƒ)
          zip: true

      # 8. Chromatic ê²°ê³¼ ì¶œë ¥
      - name: Output Chromatic URL
        if: success()
        run: |
          echo "ğŸ“š Storybook URL: ${{ steps.chromatic.outputs.storybookUrl }}"
          echo "ğŸ”— Build URL: ${{ steps.chromatic.outputs.buildUrl }}"
          echo "ğŸ“Š Changes: ${{ steps.chromatic.outputs.changeCount }}"
